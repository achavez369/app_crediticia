<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BLITZ ‚Äî Pre‚ÄëEvaluaci√≥n (Demo)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f7f7f8; --text:#111827; --muted:#6b7280; --input:#ffffff; --border:#e5e7eb;
      --focus:#E60000; --btn:#E60000; --btn-press:#cc0000; --radius:14px; --shadow:0 10px 30px rgba(17,24,39,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:'Open Sans',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,'Noto Sans','Liberation Sans',sans-serif;padding:16px;}
    /* Intro: gradiente centrado, claro y corporativo */
    body.intro{min-height:100vh; display:flex; align-items:center; justify-content:center;
      background:
        radial-gradient(120% 70% at 50% -20%, #fff0f0, transparent 60%),
        radial-gradient(120% 70% at 50% 120%, #fff5f5, transparent 60%),
        #ffffff; padding:16px;}
    .container{max-width:760px;margin:0 auto;width:100%}
    .hidden{display:none}

    /* Fuerza ocultar stepbar cuando tenga la clase hidden */
    .stepbar.hidden{display:none !important}

    /* Card base (claro, corporativo) */
    .card{background:#ffffff; border:1px solid var(--border); border-radius:20px; padding:24px 20px; box-shadow:var(--shadow);}
    @media(min-width:640px){.card{padding:32px 28px}}

    /* Intro card */
    #step-0.card{border-radius:20px; box-shadow:0 24px 60px rgba(17,24,39,.08); padding:56px 28px; max-width:520px; margin:auto; text-align:center;}

    h1{margin:8px 0 6px;font-size:28px;line-height:1.2}
    .subtitle{color:var(--muted);margin:0 0 18px}
    label{display:block;font-weight:600;margin:8px 0 6px;color:#374151}

    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:760px){.cols-2{grid-template-columns:1fr 1fr;gap:16px}}

    .input,.select{width:100%;background:var(--input);color:var(--text);border:1px solid var(--border);border-radius:12px;padding:14px;outline:none;transition:.18s}
    .input:focus,.select:focus{border-color:var(--focus);box-shadow:0 0 0 3px rgba(230,0,0,.15)}

    .actions{display:flex;gap:12px;justify-content:space-between;margin-top:22px}
    .btn{flex:1;padding:14px;border-radius:12px;border:1px solid transparent;font-weight:700;cursor:pointer}
    .btn-primary{background:linear-gradient(180deg,#ff4d4d,#E60000);color:#fff;box-shadow:0 8px 18px rgba(230,0,0,.35)}
    .btn-primary:hover{filter:brightness(1.06)}
    .btn-secondary{background:#ffffff;border-color:#d1d5db;color:#374151}
    .btn-secondary:hover{background:#f3f4f6}
    /* Segmented control Moneda */
    .segmented{display:inline-flex;gap:6px;padding:6px;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow)}
    .segmented .seg{border:0;background:transparent;padding:8px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .segmented .seg.active{background:linear-gradient(180deg,#ff4d4d,#E60000);color:#fff;box-shadow:0 6px 12px rgba(230,0,0,.25)}

    /* Input precio con prefijo */
    .moneyWrap{position:relative;display:block}
    .moneyWrap .input{width:100%;padding-left:48px}
    .moneyWrap .prefix{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-weight:700;color:#6b7280;border:0;background:transparent;min-width:auto;padding:0}
    
    /* Fila con switch + input precio */
    .inlineRow{display:grid;grid-template-columns:auto 1fr;gap:12px;align-items:center}



    /* Stepbar */
    .stepbar{display:flex;align-items:center;gap:12px;margin:14px 0;color:var(--muted);font-weight:600}
    .progress{flex:1;height:8px;background:#e5e7eb;border-radius:999px;position:relative;overflow:hidden}
    .progress span{position:absolute;left:0;top:0;bottom:0;width:20%;background:linear-gradient(90deg,#ff4d4d,#E60000);border-radius:999px;transition:width .25s ease}

    /* Chip */
    .chip{display:inline-block;background:linear-gradient(180deg,#ff4d4d,#E60000);color:#fff;font-weight:800;padding:8px 14px;border-radius:12px;letter-spacing:.4px;box-shadow:0 10px 20px rgba(230,0,0,.28)}
    
    /* Ocultar stepbar en la pantalla de introducci√≥n */
    body.intro .stepbar{display:none !important}

      /* Summary key/value layout */
    .kv{display:grid;grid-template-columns:1fr auto;gap:8px}
    .kv dt{color:var(--muted)}
    .kv dd{margin:0;text-align:right;font-weight:700}
    .sectionTitle{font-weight:700;margin:4px 0 10px}

      /* Modal (popup) */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(17,24,39,.45);z-index:1000;padding:16px}
    .modal.show{display:flex}
    .modal-card{position:relative;background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 30px 70px rgba(0,0,0,.2);max-width:560px;width:100%;padding:24px 20px}
    .modal-x{position:absolute;right:16px;top:12px;font-size:22px;cursor:pointer;color:#6b7280;background:transparent;border:0}
    .okIcon{width:64px;height:64px;background:#dcfce7;color:#16a34a;border-radius:999px;display:flex;align-items:center;justify-content:center;margin:0 auto 8px;font-size:34px}
    .notice{background:#f3f4f6;border-radius:12px;padding:12px 14px;display:flex;flex-direction:column;align-items:center;gap:6px;text-align:center;margin-top:14px}
    .notice .email{color:var(--muted);font-weight:600}
    .modal-actions{display:flex;gap:12px;margin-top:18px}
    .btn-purple{background:linear-gradient(180deg,#8b5cf6,#7c3aed);color:#fff;box-shadow:0 8px 18px rgba(124,58,237,.35)}

      .center{ text-align:center }

      /* Mejoras de responsividad para m√≥vil */
    .kv dt,.kv dd{overflow-wrap:anywhere;word-break:break-word}
    @media (max-width: 520px){
      .kv{grid-template-columns:1fr}
      .kv dd{text-align:left;font-weight:700}
      .kv dt{margin-top:8px}
      .inlineRow{grid-template-columns:1fr}
      .actions{flex-direction:column}
    }

  </style>
</head>
<body>
  <main class="container">
    <!-- INTRO / Paso 0 -->
    <section id="step-0" class="card center">
      <div><span class="chip">BLITZ</span></div>
      <h1 style="margin-top:16px">Bienvenido a Blitz</h1>
      <p class="subtitle">Tu plataforma de evaluaci√≥n crediticia r√°pida y segura</p>
      <button id="start" class="btn btn-primary" style="width:100%">Iniciar Pre‚ÄëEvaluaci√≥n</button>
    </section>

    <!-- Stepbar desde Paso 1 (se oculta en intro) -->
    <div id="stepbarWrap" class="stepbar hidden" aria-label="Progreso">
      <div>Paso <strong id="stepNow">1</strong> de <strong>5</strong></div>
      <div class="progress" role="progressbar"><span id="bar"></span></div>
      <div id="percent">25%</div>
    </div>

    <!-- PASO 1: Datos Personales -->
    <section id="step-1" class="card hidden" aria-labelledby="t1">
      <h1 id="t1">Datos Personales</h1>
      <p class="subtitle">Ingresa tu informaci√≥n personal b√°sica</p>
      <form id="form-1" class="grid" novalidate>
        <div class="grid cols-2">
          <div>
            <label for="docType">Tipo de Documento</label>
            <select id="docType" class="select" required>
              <option value="" selected disabled>Selecciona tipo de documento</option>
              <option value="171">DNI</option>
              <option value="174">RUC</option>
            </select>
          </div>
          <div>
            <label for="docNumber">N√∫mero de Documento</label>
            <input id="docNumber" class="input" type="text" inputmode="numeric" placeholder="Ingresa tu n√∫mero de documento" required>
          </div>
        </div>
        <div class="grid cols-2">
          <div>
            <label for="marital">Estado Civil</label>
            <select id="marital" class="select" required>
              <option value="" selected disabled>Selecciona tu estado civil</option>
              <option value="1">Soltero(a)</option>
              <option value="2">Casado(a)</option>
              <option value="3">Conviviente</option>
            </select>
          </div>
          <div>
            <label for="email">Email</label>
            <input id="email" class="input" type="email" placeholder="tu@email.com" required>
          </div>
        </div>
        <div class="grid cols-2">
          <div>
            <label for="phone">Tel√©fono</label>
            <input id="phone" class="input" type="tel" inputmode="numeric" placeholder="9 d√≠gitos" required minlength="9" maxlength="9" pattern="\d{9}" title="Debe tener 9 d√≠gitos">
          </div>
          <div></div>
        </div>
        <div class="actions">
          <button type="button" class="btn btn-secondary" disabled>‚Üê Atr√°s</button>
          <button type="submit" class="btn btn-primary">Siguiente ‚Üí</button>
        </div>
      </form>
    </section>

    <!-- PASO 2: Datos del C√≥nyuge (condicional) -->
    <section id="step-2" class="card hidden" aria-labelledby="t2">
      <h1 id="t2">Datos del C√≥nyuge</h1>
      <p class="subtitle">Solo si elegiste Casado(a) o Conviviente</p>
      <form id="form-2" class="grid" novalidate>
        <div class="grid cols-2">
          <div>
            <label for="spDocType">Tipo de documento</label>
            <select id="spDocType" class="select">
              <option value="" selected disabled>Selecciona tipo</option>
              <option value="171">DNI</option>
              <option value="174">RUC</option>
            </select>
          </div>
          <div>
            <label for="spDocNumber">N¬∫ de documento</label>
            <input id="spDocNumber" class="input" type="text" inputmode="numeric" placeholder="Ingresa n√∫mero">
          </div>
        </div>
        <div class="grid cols-2">
          <div>
            <label for="spLabor">Rubro laboral</label>
            <select id="spLabor" class="select">
              <option value="" selected disabled>Selecciona rubro</option>
              <option value="dependiente">Dependiente</option>
              <option value="independiente">Independiente</option>
            </select>
          </div>
          <div>
            <label for="spIncome">Ingreso neto</label>
            <div class="moneyWrap"><span class="prefix">S/</span><input id="spIncome" class="input" type="number" min="0" step="0.01" placeholder="0.00"></div>
          </div>
        </div>
        <div class="actions">
          <button type="button" class="btn btn-secondary" data-back>‚Üê Atr√°s</button>
          <button type="submit" class="btn btn-primary">Siguiente ‚Üí</button>
        </div>
      </form>
    </section>

    <!-- PASO 3: Veh√≠culo y Financiamiento -->
    <section id="step-3" class="card hidden" aria-labelledby="t3">
      <h1 id="t3">Datos del Veh√≠culo</h1>
      <p class="subtitle">Selecciona el veh√≠culo y las condiciones de financiamiento</p>
      <form id="form-3" class="grid" novalidate>
        <!-- Veh√≠culo -->
        <div class="grid cols-2">
          <div>
            <label for="brand">Marca</label>
            <select id="brand" class="select" required>
              <option value="" disabled selected>Selecciona marca</option>
              <option value="KIA">Kia</option>
            </select>
          </div>
          <div>
            <label for="model">Modelo</label>
            <select id="model" class="select" required disabled>
              <option value="" disabled selected>Selecciona modelo</option>
            </select>
          </div>
        </div>
        <div class="grid cols-2">
          <div>
            <label for="version">Versi√≥n</label>
            <select id="version" class="select" required disabled>
              <option value="" disabled selected>Selecciona versi√≥n</option>
            </select>
          </div>
          <div>
            <label for="gps">¬øIncluye GPS?</label>
            <select id="gps" class="select" required>
              <option value="" disabled selected>Selecciona</option>
              <option value="S">S√≠</option>
              <option value="N">No</option>
            </select>
          </div>
        </div>
        <!-- Precio / Moneda (switch e input en la misma fila) -->
        <div>
          <label for="price">Precio del veh√≠culo</label>
          <div class="inlineRow">
            <div class="segmented" role="group" aria-label="Selecciona moneda">
              <button type="button" id="segPEN" class="seg" aria-pressed="false">S/</button>
              <button type="button" id="segUSD" class="seg active" aria-pressed="true">USD</button>
            </div>
            <div class="moneyWrap">
              <span class="prefix" id="curPrefix">$</span>
              <input id="price" class="input" type="number" min="0" step="0.01" placeholder="0.00" required>
            </div>
          </div>
        </div>
        <div>
          <label for="down">Cuota inicial</label>
          <div class="moneyWrap">
            <span class="prefix">S/</span>
            <input id="down" class="input" type="number" min="0" step="0.01" placeholder="0.00" required>
          </div>
          <div id="downError" class="helper hidden">La cuota inicial no puede superar el precio del veh√≠culo.</div>
        </div>
        <!-- Financiamiento -->
        <div class="grid cols-2">
          <div>
            <label for="term">Plazo</label>
            <select id="term" class="select" required>
              <option value="" disabled selected>Selecciona plazo en meses</option>
              <option>12</option>
              <option>24</option>
              <option>36</option>
              <option>48</option>
              <option>60</option>
              <option>72</option>
            </select>
          </div>
          <div>
            <label for="insurance">¬øSeguro vehicular del banco?</label>
            <select id="insurance" class="select" required>
              <option value="" disabled selected>Selecciona</option>
              <option value="S">S√≠</option>
              <option value="N">No</option>
            </select>
          </div>
        </div>
        <div class="actions">
          <button type="button" class="btn btn-secondary" data-back>‚Üê Atr√°s</button>
          <button type="submit" class="btn btn-primary">Evaluar ‚Üí</button>
        </div>
      </form>
    </section>

    <!-- PASO 4: Resumen -->
    <section id="step-4" class="card hidden" aria-labelledby="t4">
      <h1 id="t4">Resumen de Solicitud</h1>
      <p class="subtitle">Revisa tus datos antes de enviar</p>
      <div class="card" id="sum-personal"></div>
      <div class="card" id="sum-spouse" style="display:none"></div>
      <div class="card" id="sum-vehicle"></div>
      <div class="actions">
        <button type="button" class="btn btn-secondary" data-back>‚Üê Atr√°s</button>
        <button type="button" class="btn btn-primary" id="confirmSend">Enviar ‚Üí</button>
      </div>
    </section>
    <section id="step-5" class="card hidden" aria-labelledby="t5">
      <h1 id="t5">Resultado</h1>
      <p class="subtitle">Simulaci√≥n local (sin conexi√≥n a API)</p>
      <div id="resultBox"></div>
      <div class="actions">
        <button type="button" class="btn btn-secondary" data-back>‚Üê Atr√°s</button>
        <button type="button" class="btn btn-primary" id="restart">Empezar de nuevo</button>
      </div>
    </section>

      <!-- Modal de √©xito -->
    <div id="modalSuccess" class="modal" role="dialog" aria-modal="true" aria-labelledby="msTitle">
      <div class="modal-card">
        <button class="modal-x" id="msClose" aria-label="Cerrar">√ó</button>
        <div class="okIcon">‚úì</div>
        <h2 id="msTitle" class="center" style="margin-top:8px">¬°Gracias por confiar en Blitz!</h2>
        <p class="subtitle center" style="margin-top:2px">Hemos recibido tu solicitud de pre‚Äëevaluaci√≥n crediticia correctamente.</p>
        <div class="notice">
          <div><span>üìß</span> <strong>Te enviaremos el resultado por email</strong></div>
          <div class="email" id="msEmail"></div>
        </div>
        <p class="center" style="margin:14px 0 0">Recibir√°s una respuesta en las pr√≥ximas 24 horas</p>
        <div class="modal-actions">
          <button type="button" class="btn btn-primary" id="msGoBot">Regresar al bot</button>
          <button type="button" class="btn btn-secondary" id="msClose2">Cerrar</button>
        </div>
      </div>
    </div>

  </main>

  <script>
    // Helpers
    const $=s=>document.querySelector(s); const $$=s=>document.querySelectorAll(s);
    const steps=[$('#step-0'),$('#step-1'),$('#step-2'),$('#step-3'),$('#step-4'),$('#step-5')];
    const stepbar=$('#stepbarWrap'); const now=$('#stepNow'); const bar=$('#bar'); const pct=$('#percent');
    let current=0; let skipSpouse=false; // para saber si se salta el paso 2

    function progress(n){
      if(n===0){stepbar.classList.add('hidden'); return;}
      stepbar.classList.remove('hidden');
      now.textContent=n; const p=Math.round((n/5)*100); pct.textContent=p+'%'; bar.style.width=p+'%';
    }
    function go(n){ steps.forEach((el,i)=>el.classList.toggle('hidden',i!==n)); current=n; progress(n); document.body.classList.toggle('intro',n===0); window.scrollTo({top:0,behavior:'smooth'}); }

    // Intro
    $('#start').addEventListener('click',()=>go(1));

    // Paso 1
    const f1=$('#form-1'); const marital=$('#marital'); const doc=$('#docNumber'); const phone=$('#phone');
    const digits=el=>el.addEventListener('input',()=>{ el.value=el.value.replace(/[^0-9]+/g,'');});
    digits(doc); digits(phone); phone.addEventListener('input',()=>{ phone.value = phone.value.replace(/\D+/g,'').slice(0,9); });

    f1.addEventListener('submit',e=>{ e.preventDefault(); if(!f1.checkValidity()){shake(f1);return}
      const civil=marital.value; if(civil==='2'||civil==='3'){ skipSpouse=false; go(2);} else { skipSpouse=true; go(3);} });

    // Paso 2
    const f2=$('#form-2'); const spDocType=$('#spDocType'); const spDocNumber=$('#spDocNumber'); digits(spDocNumber);
    f2.addEventListener('submit',e=>{ e.preventDefault(); spDocType.required=true; spDocNumber.required=true; if(!f2.checkValidity()){shake(f2);return} go(3); });

    // Paso 3 (cat√°logos dependientes + validaci√≥n cuota)
    const f3=$('#form-3');
    const brand=$('#brand'), model=$('#model'), version=$('#version');
    const price=$('#price'), down=$('#down'); const term=$('#term');
    // Estado de moneda (switch)
    const segPEN=$('#segPEN'), segUSD=$('#segUSD'), curPrefix=$('#curPrefix');
    let currencyCode='USD'; // por defecto USD
    function setCurrency(code){
      currencyCode=code;
      segPEN.classList.toggle('active', code==='PEN');
      segUSD.classList.toggle('active', code==='USD');
      segPEN?.setAttribute('aria-pressed', code==='PEN');
      segUSD?.setAttribute('aria-pressed', code==='USD');
      curPrefix.textContent = code==='USD' ? '$' : 'S/';
    }
    segPEN?.addEventListener('click',()=>setCurrency('PEN'));
    segUSD?.addEventListener('click',()=>setCurrency('USD'));
    setCurrency('USD');
    const resultBox=$('#resultBox'); const downError=$('#downError');

    const catalog={ KIA:{ models:{
      "Picanto": {versions:["LX","EX","GT-Line"]},
      "Rio": {versions:["LX","EX"]},
      "Seltos": {versions:["LX","EX","GT-Line"]},
      "Sportage": {versions:["LX","EX"]},
      "Cerato": {versions:["LX","EX"]}
    }} };
    brand.addEventListener('change',()=>{
      model.innerHTML='<option disabled selected>Selecciona modelo</option>';
      version.innerHTML='<option disabled selected>Selecciona versi√≥n</option>'; version.disabled=true;
      const m=catalog[brand.value]?.models||{}; Object.keys(m).forEach(id=>{ const o=document.createElement('option'); o.value=id; o.textContent=id; model.appendChild(o)}); model.disabled=false;
    });
    model.addEventListener('change',()=>{
      version.innerHTML='<option disabled selected>Selecciona versi√≥n</option>';
      const v=catalog[brand.value]?.models?.[model.value]?.versions||[]; v.forEach(id=>{ const o=document.createElement('option'); o.value=id; o.textContent=id; version.appendChild(o)}); version.disabled=false;
    });

    function validateDown(){ const d=+down.value||0, p=+price.value||0; if(d>p){ down.setCustomValidity('error'); downError.classList.remove('hidden'); } else { down.setCustomValidity(''); downError.classList.add('hidden'); } }
    down.addEventListener('input',validateDown); price.addEventListener('input',validateDown);

    f3.addEventListener('submit',e=>{ e.preventDefault(); if(!f3.checkValidity()){shake(f3);return} renderSummary(); go(4); });

    // ===== Resumen: render y confirmaci√≥n =====
    function renderSummary(){
      const docMap={'171':'DNI','174':'RUC'};
      const civilMap={'1':'Soltero(a)','2':'Casado(a)','3':'Conviviente'};
      const yesNo={'S':'S√≠','N':'No'};
      // Datos personales
      $('#sum-personal').innerHTML = `
        <div class="sectionTitle">Datos Personales</div>
        <dl class="kv">
          <dt>Documento:</dt><dd>${docMap[$('#docType').value]||'‚Äî'} ${$('#docNumber').value||''}</dd>
          <dt>Estado Civil:</dt><dd>${civilMap[$('#marital').value]||'‚Äî'}</dd>
          <dt>Email:</dt><dd>${$('#email').value||'‚Äî'}</dd>
          <dt>Tel√©fono:</dt><dd>${$('#phone').value||'‚Äî'}</dd>
        </dl>`;
      // C√≥nyuge condicional
      const showSpouse = ($('#marital').value==='2'||$('#marital').value==='3');
      $('#sum-spouse').style.display = showSpouse ? 'block' : 'none';
      if (showSpouse){
        $('#sum-spouse').innerHTML = `
          <div class="sectionTitle">Datos del C√≥nyuge</div>
          <dl class="kv">
            <dt>Documento:</dt><dd>${docMap[$('#spDocType').value]||'‚Äî'} ${$('#spDocNumber').value||''}</dd>
            <dt>Rubro laboral:</dt><dd>${$('#spLabor').selectedOptions[0]?.text||'‚Äî'}</dd>
            <dt>Ingreso neto:<\/dt><dd>S/ \${fmt(+($('#spIncome').value||0))}</dd>
          </dl>`;
      }
      // Veh√≠culo y financiamiento
      const brandTxt=$('#brand').selectedOptions[0]?.text||'‚Äî';
      const modelTxt=$('#model').selectedOptions[0]?.text||'‚Äî';
      const versionTxt=$('#version').selectedOptions[0]?.text||'‚Äî';
      const yesNoTxt= yesNo[$('#gps').value]||'‚Äî';
      const cur=currencyCode; const curSym=cur==='USD'?'$':'S/';
      $('#sum-vehicle').innerHTML = `
        <div class="sectionTitle">Veh√≠culo y Financiamiento</div>
        <dl class="kv">
          <dt>Marca:</dt><dd>${brandTxt}</dd>
          <dt>Modelo:</dt><dd>${modelTxt}</dd>
          <dt>Versi√≥n:</dt><dd>${versionTxt}</dd>
          <dt>GPS:</dt><dd>${yesNoTxt}</dd>
          <dt>Moneda:</dt><dd>${cur}</dd>
          <dt>Precio del veh√≠culo:</dt><dd>${curSym} ${fmt(+($('#price').value||0))}</dd>
          <dt>Cuota inicial:</dt><dd>${curSym} ${fmt(+($('#down').value||0))}</dd>
          <dt>Plazo:<\/dt><dd>${$('#term').value||'‚Äî'}</dd>
          <dt>Seguro del banco:</dt><dd>${yesNo[$('#insurance').value]||'‚Äî'}</dd>
        </dl>`;
    }

    const modal=$('#modalSuccess'); const msClose=$('#msClose'), msClose2=$('#msClose2'), msGoBot=$('#msGoBot'), msEmail=$('#msEmail');
    function openModal(){ if(msEmail){ const val=($('#email').value||'').trim(); msEmail.textContent = val || '‚Äî'; } modal.classList.add('show'); }
    function closeModal(){ modal.classList.remove('show'); }
    [msClose, msClose2].forEach(b=>b?.addEventListener('click', closeModal));
    msGoBot?.addEventListener('click', ()=>{ closeModal(); go(0); });
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

    $('#confirmSend')?.addEventListener('click',()=>{
      const financed=Math.max((+price.value||0)-(+down.value||0),0); const months=+term.value||0; const tea=0.2499; const r=tea/12; const pay=financed>0&&months>0? (financed*r)/(1-Math.pow(1+r,-months)):0; const cur=currencyCode;
      const ok=(+down.value)>=0.1*(+price.value) && financed>0;
      resultBox.innerHTML = ok
        ? `<div style="border:1px solid #3ddc97;color:#b2f5d6;background:rgba(61,220,151,.08);padding:8px 10px;border-radius:999px;display:inline-block">Pre‚Äëaprobado</div>
           <h2 style="margin:8px 0 10px">¬°Felicidades! üéâ</h2>
           <p class="subtitle">TEA estimada <strong>24.99%</strong> ‚Äî cuota aproximada <strong>${cur} ${fmt(pay)}</strong> a <strong>${months}</strong> meses.</p>`
        : `<div style="border:1px solid #ff6b6b;color:#ffc4c4;background:rgba(255,107,107,.08);padding:8px 10px;border-radius:999px;display:inline-block">No aprobado</div>
           <h2 style=\"margin:8px 0 10px\">Lo sentimos</h2>
           <p class=\"subtitle\">Aumenta la cuota inicial (‚â•10%) o ajusta el plazo e int√©ntalo de nuevo.</p>`;
      openModal();
    });

    // back / restart (delegado para evitar problemas en botones dentro de formularios)
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-back]');
      if (!btn) return;
      e.preventDefault();
      if (current === 3 && skipSpouse) { go(1); }
      else { go(Math.max(1, current - 1)); }
    });

    $('#restart').addEventListener('click', () => location.reload());

    // Inicia en intro con gradiente
    go(0);

    function fmt(n){return n.toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}
    function shake(el){ el.animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:220}); [...el.elements].forEach(i=>i.reportValidity && i.reportValidity()); }
  </script>
</body>
</html>
